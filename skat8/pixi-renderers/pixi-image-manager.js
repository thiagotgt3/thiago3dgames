var gdjs;(function(l){const n=new l.Logger("PIXI Image manager"),u=(o,e)=>{n.error("Unable to load file "+o+" with error:",e||"(unknown error)")},c=(o,e)=>{!o||e.smoothed||(o.baseTexture.scaleMode=PIXI.SCALE_MODES.NEAREST)},T=(o,e)=>{e&&!e.smoothed&&(o.magFilter=THREE.NearestFilter,o.minFilter=THREE.NearestFilter)},d=(o,e,r)=>{const t=o.get(e);return t&&t.kind===r?t:null};class g{constructor(e,r){this._resources=new Map,this.setResources(e),this._resourcesLoader=r,this._invalidTexture=PIXI.Texture.from("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAgAAAAICAYAAADED76LAAAAFElEQVQoU2P8z/D/PwMewDgyFAAApMMX8Zi0uXAAAAAASUVORK5CYIIA"),this._loadedTextures=new Hashtable,this._loadedThreeTextures=new Hashtable,this._loadedThreeMaterials=new Hashtable}setResources(e){this._resources.clear();for(const r of e)(r.kind==="image"||r.kind==="video")&&this._resources.set(r.name,r)}getPIXITexture(e){if(this._loadedTextures.containsKey(e)){const i=this._loadedTextures.get(e);if(i.valid)return i;n.error("Texture for "+e+" is not valid anymore (or never was).")}if(e==="")return this._invalidTexture;const r=d(this._resources,e,"image");if(!r)return n.warn('Unable to find texture for resource "'+e+'".'),this._invalidTexture;n.log('Loading texture for resource "'+e+'"...');const t=r.file,s=PIXI.Texture.from(this._resourcesLoader.getFullUrl(t),{resourceOptions:{crossorigin:this._resourcesLoader.checkIfCredentialsRequired(t)?"use-credentials":"anonymous"}}).on("error",i=>{u(t,i)});return c(s,r),this._loadedTextures.put(e,s),s}getThreeTexture(e){const r=this._loadedThreeTextures.get(e);if(r)return r;const t=this.getPIXITexture(e);if(!this._resourcesLoader._runtimeGame.getRenderer().getPIXIRenderer())throw new Error("No PIXI renderer was found.");const i=t.baseTexture.resource.source;if(!(i instanceof HTMLImageElement))throw new Error(`Can't load texture for resource "${e}" as it's not an image.`);const a=new THREE.Texture(i);a.magFilter=THREE.LinearFilter,a.minFilter=THREE.LinearFilter,a.wrapS=THREE.RepeatWrapping,a.wrapT=THREE.RepeatWrapping,a.colorSpace=THREE.SRGBColorSpace,a.needsUpdate=!0;const h=d(this._resources,e,"image");return T(a,h),this._loadedThreeTextures.put(e,a),a}getThreeMaterial(e,{useTransparentTexture:r,forceBasicMaterial:t}){const s=`${e}|${r?1:0}|${t?1:0}`,i=this._loadedThreeMaterials.get(s);if(i)return i;const a=t?new THREE.MeshBasicMaterial({map:this.getThreeTexture(e),side:r?THREE.DoubleSide:THREE.FrontSide,transparent:r}):new THREE.MeshStandardMaterial({map:this.getThreeTexture(e),side:r?THREE.DoubleSide:THREE.FrontSide,transparent:r,metalness:0});return this._loadedThreeMaterials.put(s,a),a}getPIXIVideoTexture(e){if(this._loadedTextures.containsKey(e))return this._loadedTextures.get(e);if(e==="")return this._invalidTexture;const r=d(this._resources,e,"video");if(!r)return n.warn('Unable to find video texture for resource "'+e+'".'),this._invalidTexture;const t=r.file;n.log('Loading video texture for resource "'+e+'"...');const s=PIXI.Texture.from(this._resourcesLoader.getFullUrl(t),{resourceOptions:{crossorigin:this._resourcesLoader.checkIfCredentialsRequired(t)?"use-credentials":"anonymous"}}).on("error",i=>{u(t,i)});return this._loadedTextures.put(e,s),s}getInvalidPIXITexture(){return this._invalidTexture}async loadTextures(e){let r=0;return await Promise.all([...this._resources.values()].map(async t=>{try{PIXI.Assets.setPreferences({preferWorkers:!1,preferCreateImageBitmap:!1,crossOrigin:this._resourcesLoader.checkIfCredentialsRequired(t.file)?"use-credentials":"anonymous"});const s=await PIXI.Assets.load(t.file);this._loadedTextures.put(t.name,s),c(s,t)}catch(s){u(t.file,s)}r++,e(r,this._resources.size)})),r}}l.PixiImageManager=g,l.ImageManager=l.PixiImageManager})(gdjs||(gdjs={}));
//# sourceMappingURL=pixi-image-manager.js.map
